# 가격 검색 작동 방식 설명

## 현재 구현 상태

### ✅ 구현된 것
1. **네이버 쇼핑 API 연동**
   - 네이버 쇼핑 검색 API를 사용하여 LP 가격 검색
   - 최대 5개의 결과를 수집

2. **검증 로직**
   - 아티스트명 매칭 필수
   - 앨범명 80-85% 매칭 (LP 키워드 유무에 따라)
   - 가격 범위 검증 (20,000원 ~ 1,000,000원)
   - 도메인 화이트리스트 (신뢰할 수 있는 판매처만)

3. **Vercel Serverless Function**
   - `/api/search-prices` 엔드포인트
   - 캐시 확인 (24시간 이내 데이터 재사용)
   - 실시간 검색 후 DB 저장

### ❌ 아직 구현 안 된 것
1. **다른 판매처**
   - Yes24, 알라딘, 교보문고, 인터파크 등은 `scripts/sync-lp-data.ts`에 있지만
   - Vercel Function에서는 사용하지 않음 (네이버만 사용)

2. **검증 로직의 한계**
   - 검증이 너무 엄격하면 실제 LP도 필터링될 수 있음
   - 검증이 너무 느슨하면 CD나 다른 상품이 포함될 수 있음

## 작동 방식

### 1. 사용자가 "가격 검색" 버튼 클릭
```
프론트엔드 → /api/search-prices (POST)
```

### 2. API 처리 순서
1. **캐시 확인**: 24시간 이내 데이터가 있으면 즉시 반환
2. **실시간 검색**: 없으면 네이버 쇼핑 API 호출
3. **검증 및 필터링**: 
   - 아티스트명 매칭 확인
   - 앨범명 매칭 확인 (80-85%)
   - 가격 범위 확인
   - 도메인 화이트리스트 확인
4. **DB 저장**: 검색 결과를 `lp_offers` 테이블에 저장
5. **결과 반환**: 프론트엔드에 검색 결과 전달

### 3. 검색 쿼리
- EAN이 있으면: EAN으로 검색
- EAN이 없으면: `"아티스트명 앨범명 LP"`로 검색

## 문제점과 해결책

### 문제 1: 결과가 적음
**원인**: 
- 네이버만 검색
- 검증 로직이 엄격

**해결책**:
- 검증 로직 완화 (95% → 80-85%)
- 여러 결과 수집 (1개 → 최대 5개)
- LP 키워드가 없어도 아티스트+앨범명이 정확하면 통과

### 문제 2: 환경 변수 필요
**필수 환경 변수**:
- `NAVER_CLIENT_ID`
- `NAVER_CLIENT_SECRET`
- `VITE_SUPABASE_URL` (또는 `SUPABASE_URL`)
- `VITE_SUPABASE_SERVICE_ROLE_KEY` (또는 `SUPABASE_SERVICE_ROLE_KEY`)

**없으면**: 검색이 작동하지 않음 (빈 배열 반환)

### 문제 3: 다른 판매처 미구현
**현재**: 네이버만 검색
**향후**: Yes24, 알라딘 등 추가 가능 (하지만 각각 API 키 필요)

## 테스트 방법

### 1. 테스트 페이지
```
https://your-vercel-url.vercel.app/test-price-search.html
```

### 2. 브라우저 콘솔
```javascript
fetch('/api/search-prices', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    artist: 'Lana Del Rey',
    title: 'Born To Die',
    ean: '602527240420'
  })
})
.then(r => r.json())
.then(console.log)
```

## 결론

**지금 작동하는 것**:
- ✅ 네이버 쇼핑에서 LP 가격 검색
- ✅ 검증 로직으로 부정확한 결과 필터링
- ✅ 캐시로 빠른 응답
- ✅ DB에 결과 저장

**작동 안 하는 것**:
- ❌ 다른 판매처 (Yes24, 알라딘 등) - 아직 구현 안 됨
- ❌ 환경 변수가 없으면 작동 안 함

**결과**:
- 네이버에 있는 LP는 검색 가능
- 네이버에 없거나 검증을 통과하지 못하면 결과 없음
- 검증 로직이 완화되어서 이전보다 더 많은 결과가 나올 수 있음
